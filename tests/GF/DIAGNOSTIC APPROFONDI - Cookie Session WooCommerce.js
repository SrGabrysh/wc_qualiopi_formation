/**
 * üî¨ DIAGNOSTIC APPROFONDI - Cookie Session WooCommerce
 * 
 * Analyse pourquoi le cookie de session n'est pas accessible
 * alors que le panier contient un produit
 */

(function() {
  'use strict';
  
  console.clear();
  console.log('%cüî¨ DIAGNOSTIC COOKIE SESSION WOOCOMMERCE', 'background: #d63638; color: white; padding: 8px; font-weight: bold; font-size: 14px');
  console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #ddd');
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 1. ANALYSE DES COOKIES DISPONIBLES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  console.log('%c\nüì¶ √âTAPE 1 : Analyse compl√®te des cookies', 'color: #2271b1; font-weight: bold');
  console.log('%c‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ddd');
  
  const allCookies = document.cookie.split(';').map(c => c.trim());
  
  console.log(`\nüìä Nombre total de cookies : ${allCookies.length}`);
  console.log('\nüîç Liste compl√®te des cookies :');
  
  const cookieDetails = {};
  allCookies.forEach((cookie, index) => {
      const [name, value] = cookie.split('=');
      cookieDetails[name] = value ? value.substring(0, 50) + '...' : '(vide)';
      console.log(`  ${index + 1}. ${name}`);
  });
  
  // Rechercher TOUS les cookies WooCommerce
  console.log('\nüõí Cookies WooCommerce d√©tect√©s :');
  const wcCookies = allCookies.filter(c => 
      c.toLowerCase().includes('woocommerce') || 
      c.toLowerCase().includes('wc_') ||
      c.startsWith('wp_woocommerce')
  );
  
  if (wcCookies.length > 0) {
      wcCookies.forEach(cookie => {
          console.log(`%c  ‚úì ${cookie.split('=')[0]}`, 'color: #00a32a');
      });
  } else {
      console.log('%c  ‚úó Aucun cookie WooCommerce trouv√©', 'color: #d63638; font-weight: bold');
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 2. RECHERCHE SP√âCIFIQUE DU COOKIE SESSION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  console.log('%c\nüîë √âTAPE 2 : Recherche cookie session', 'color: #2271b1; font-weight: bold');
  console.log('%c‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ddd');
  
  // Patterns possibles pour le cookie de session
  const sessionPatterns = [
      'wp_woocommerce_session_',
      'woocommerce_session_',
      'wc_session_',
  ];
  
  let sessionCookie = null;
  let sessionPattern = null;
  
  for (const pattern of sessionPatterns) {
      sessionCookie = allCookies.find(c => c.startsWith(pattern));
      if (sessionCookie) {
          sessionPattern = pattern;
          break;
      }
  }
  
  if (sessionCookie) {
      console.log('%c‚úì Cookie de session trouv√© !', 'color: #00a32a; font-weight: bold');
      console.log(`  Pattern : ${sessionPattern}`);
      console.log(`  Cookie : ${sessionCookie.split('=')[0]}`);
      
      // Parser le cookie
      const cookieValue = sessionCookie.split('=')[1];
      if (cookieValue) {
          const decoded = decodeURIComponent(cookieValue);
          const parts = decoded.split('||');
          
          console.log('\nüìã Contenu du cookie :');
          console.log(`  ‚Ä¢ Customer ID (session_key) : ${parts[0]}`);
          if (parts[1]) console.log(`  ‚Ä¢ Expiration : ${new Date(parseInt(parts[1]) * 1000).toLocaleString()}`);
          if (parts[2]) console.log(`  ‚Ä¢ HMAC : ${parts[2].substring(0, 20)}...`);
          if (parts[3]) console.log(`  ‚Ä¢ Token : ${parts[3].substring(0, 20)}...`);
      }
  } else {
      console.log('%c‚úó AUCUN cookie de session trouv√©', 'color: #d63638; font-weight: bold');
      console.log('\nüîç Patterns recherch√©s :');
      sessionPatterns.forEach(p => console.log(`  ‚Ä¢ ${p}`));
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 3. V√âRIFICATION API PANIER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  console.log('%c\nüõí √âTAPE 3 : V√©rification API panier', 'color: #2271b1; font-weight: bold');
  console.log('%c‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ddd');
  
  fetch('/wp-json/wc/store/v1/cart', {
      method: 'GET',
      credentials: 'same-origin',
      headers: {
          'Content-Type': 'application/json',
      }
  })
  .then(response => {
      console.log(`\nüì° Statut API : ${response.status} ${response.statusText}`);
      
      // Analyser les headers de r√©ponse
      console.log('\nüì® Headers de r√©ponse (Set-Cookie) :');
      const setCookieHeaders = response.headers.get('Set-Cookie');
      if (setCookieHeaders) {
          console.log(setCookieHeaders);
      } else {
          console.log('%c  ‚ö†Ô∏è Aucun header Set-Cookie dans la r√©ponse', 'color: #dba617');
      }
      
      return response.json();
  })
  .then(cart => {
      console.log('\n‚úì R√©ponse API panier :');
      console.log(`  ‚Ä¢ Items : ${cart.items?.length || 0}`);
      console.log(`  ‚Ä¢ Total : ${cart.totals?.total_price || 'N/A'}`);
      
      if (cart.items && cart.items.length > 0) {
          console.log('\nüì¶ Produits dans le panier :');
          cart.items.forEach((item, idx) => {
              console.log(`  ${idx + 1}. ${item.name} (ID: ${item.id})`);
          });
          
          console.log('\n%c‚úì LE PANIER CONTIENT DES PRODUITS', 'color: #00a32a; font-weight: bold; font-size: 13px');
          console.log('%c‚Üí La session DEVRAIT exister c√¥t√© serveur', 'color: #00a32a');
      }
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // 4. DIAGNOSTIC DU PROBL√àME
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      console.log('%c\nüéØ √âTAPE 4 : Diagnostic du probl√®me', 'color: #2271b1; font-weight: bold');
      console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #ddd');
      
      if (!sessionCookie && cart.items && cart.items.length > 0) {
          console.log('%c\n‚ùå PROBL√àME IDENTIFI√â', 'background: #d63638; color: white; padding: 4px 8px; font-weight: bold');
          console.log('\nüìä √âtat actuel :');
          console.log('%c  ‚úì Panier contient des produits', 'color: #00a32a');
          console.log('%c  ‚úó Cookie de session ABSENT en JavaScript', 'color: #d63638');
          
          console.log('\nüî¨ Causes possibles :');
          console.log('%c\n1. Cookie HttpOnly (le plus probable)', 'color: #2271b1; font-weight: bold');
          console.log('   ‚Üí WooCommerce a cr√©√© le cookie avec le flag HttpOnly');
          console.log('   ‚Üí Le cookie existe mais n\'est PAS accessible en JavaScript');
          console.log('   ‚Üí Il est uniquement accessible c√¥t√© serveur (PHP)');
          console.log('   ‚Üí C\'est une mesure de s√©curit√© normale');
          
          console.log('%c\n2. Cookie SameSite=Strict', 'color: #2271b1; font-weight: bold');
          console.log('   ‚Üí Le cookie n\'est pas envoy√© dans certains contextes');
          
          console.log('%c\n3. Cookie Secure + HTTP', 'color: #2271b1; font-weight: bold');
          console.log('   ‚Üí Le cookie n√©cessite HTTPS mais le site est en HTTP');
          
          console.log('%c\n4. Domaine du cookie diff√©rent', 'color: #2271b1; font-weight: bold');
          console.log('   ‚Üí Le cookie est d√©fini pour un domaine parent/enfant diff√©rent');
          
          // V√©rification HTTPS
          const isHttps = window.location.protocol === 'https:';
          console.log(`\nüîí Protocole actuel : ${window.location.protocol}`);
          if (!isHttps) {
              console.log('%c  ‚ö†Ô∏è Site en HTTP (pas HTTPS)', 'color: #dba617');
              console.log('     ‚Üí Si cookie Secure=true, il ne sera pas envoy√©');
          }
          
          // Solution
          console.log('%c\n‚úÖ SOLUTION POUR TON CAS', 'background: #00a32a; color: white; padding: 4px 8px; font-weight: bold');
          console.log('\nüéØ Le plugin PHP PEUT r√©cup√©rer la session :');
          console.log('   1. Le panier existe ‚Üí session existe c√¥t√© serveur');
          console.log('   2. ProgressStorage::start() r√©cup√®re la session via PHP');
          console.log('   3. La session_id est stock√©e dans wp_wcqf_progress');
          console.log('   4. YousignIframeHandler lit depuis la BDD, PAS depuis le cookie JS');
          
          console.log('\nüìù Action requise :');
          console.log('%c   ‚Üí Tester avec le script PHP c√¥t√© serveur', 'color: #00a32a; font-weight: bold');
          console.log('   ‚Üí Le test JS ne peut PAS voir les cookies HttpOnly');
          console.log('   ‚Üí C\'est NORMAL et n\'emp√™che PAS le plugin de fonctionner');
          
      } else if (sessionCookie) {
          console.log('%c\n‚úÖ TOUT FONCTIONNE CORRECTEMENT', 'background: #00a32a; color: white; padding: 4px 8px; font-weight: bold');
      } else {
          console.log('%c\n‚ö†Ô∏è PANIER VIDE', 'background: #dba617; color: white; padding: 4px 8px; font-weight: bold');
          console.log('\n‚Üí Ajouter un produit au panier pour cr√©er la session');
      }
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // 5. SCRIPT PHP DE V√âRIFICATION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      console.log('%c\nüîß √âTAPE 5 : Test recommand√©', 'color: #2271b1; font-weight: bold');
      console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #ddd');
      
      console.log('\nüìã Ex√©cuter ce code PHP via WP-CLI ou Code Snippets :');
      console.log('%c\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ddd');
      const phpCode = `<?php
// Test rapide de r√©cup√©ration session WooCommerce
if ( function_exists('WC') && WC()->session ) {
  $session_id = WC()->session->get_customer_id();
  echo "Session ID : " . $session_id . "\\n";
  
  // V√©rifier le panier
  $cart_items = WC()->cart->get_cart();
  echo "Produits dans le panier : " . count($cart_items) . "\\n";
  
  foreach ($cart_items as $item) {
      echo "  - Produit ID : " . $item['product_id'] . "\\n";
  }
} else {
  echo "WooCommerce session non disponible\\n";
}`;
      
      console.log(phpCode);
      console.log('%c‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ddd');
      
      console.log('\nüí° Commande DDEV :');
      console.log('%cddev wp eval "if (function_exists(\'WC\') && WC()->session) { echo \'Session: \' . WC()->session->get_customer_id(); }"', 
          'background: #f0f0f1; padding: 4px; font-family: monospace; color: #1e1e1e');
      
  })
  .catch(error => {
      console.log('%c\n‚úó Erreur API panier', 'color: #d63638; font-weight: bold');
      console.error(error);
  });
  
})();